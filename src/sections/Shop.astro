---
import Product_card from "../components/product_card.astro";
import ViewProduct from "../components/view_product.astro";
import CartTab from "../components/cart_tab.astro";
import CategorySearch from "../components/category_search.astro";
---

<!-- PRODUCTS + CART -->
<section id="products" class="flex-column">
  <h2>NUESTROS PRODUCTOS</h2>

  <!-- Selector de categoría + buscador -->
  <CategorySearch />

  <!-- Grid de productos -->
  <div class="main-listProduct flex-column">
    <div class="listProduct flex-row"></div>
  </div>

  <!-- Carrito lateral -->
  <CartTab />
</section>

<!-- Vista de producto + modal -->
<ViewProduct />

<!-- Plantilla de tarjeta de producto -->
<Product_card />

<style is:inline>
  /* LISTA DE PRODUCTOS (los estilos del .item viven en product_card.astro) */
  #products {
    display: flex;
    gap: 7px;
  }
  #products .main-listProduct {
    padding: 14px 4px;
    overflow: hidden;
    width: 100%;
  }
  #products .listProduct {
    width: 100%;
    justify-content: space-evenly;
    flex-wrap: wrap;
    row-gap: 14px;
    min-height: 200px;
  }

  /* ANIMACIÓN ICONO CARRITO */
  @keyframes shake {
    0% {
      transform: translate(0, 0);
    }
    25% {
      transform: translate(-4px, 0);
    }
    50% {
      transform: translate(4px, 0);
    }
    75% {
      transform: translate(-4px, 0);
    }
    100% {
      transform: translate(0, 0);
    }
  }
  .icon-cart.animate-cart {
    animation: shake 0.3s ease-in-out;
  }

  .no-results {
    text-align: center;
    color: var(--clr-dark);
    font-weight: 500;
    font-size: 1.5rem;
    margin-top: 20px;
  }
</style>

<script is:inline>
  // Refs UI
  const $categoryButtons = document.getElementById("category-buttons");
  const $searchInput = document.getElementById("search-input");
  const listProductHTML = document.querySelector(".listProduct");
  const listCartHTML = document.querySelector(".listCart");

  const iconCart = document.querySelector(".icon-cart");
  const iconCartSpan = document.querySelector(".icon-cart span");
  const body = document.querySelector("body");
  const $viewProduct = document.getElementById("v-product");

  // Estado
  let selectedCategory = "TODOS";
  let allProductsByCategory = {};
  let products = [];
  let cart = [];
  let searchTerm = "";
  let currentProductIndex = null;

  // Utils
  const cleanImagePath = (path) => (path ? path.trim() : "");
  const normalizeText = (text) =>
    text
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "");

  // abrir carrito
  iconCart.addEventListener("click", () => body.classList.toggle("showCart"));

  // Render: botones de categoría
  const renderCategoryButtons = () => {
    $categoryButtons.innerHTML = "";
    const categories = ["TODOS", ...Object.keys(allProductsByCategory)];

    categories.forEach((category) => {
      const btn = document.createElement("button");
      btn.textContent = category;
      btn.classList.add("button2");
      if (category === selectedCategory) btn.classList.add("active");
      btn.addEventListener("click", () => {
        selectedCategory = category;
        renderCategoryButtons();
        addDataToHTML();
      });
      $categoryButtons.appendChild(btn);
    });
  };

  // Render: tarjetas de productos clonando el template del componente
  const addDataToHTML = () => {
    listProductHTML.innerHTML = "";

    const baseList =
      selectedCategory === "TODOS"
        ? Object.values(allProductsByCategory).flat()
        : allProductsByCategory[selectedCategory] || [];

    const filteredList = baseList.filter((product) =>
      normalizeText(product.name).includes(normalizeText(searchTerm)),
    );

    if (filteredList.length > 0) {
      const fragment = document.createDocumentFragment();
      const tpl = document.getElementById("product-card-tpl");

      filteredList.forEach((product) => {
        const idx = products.indexOf(product);
        const node = tpl.content.firstElementChild.cloneNode(true);

        node.dataset.id = idx;

        const img = node.querySelector("img");
        img.src = `.${cleanImagePath(product.images[0])}`;
        img.alt = product.name;

        node.querySelector(".product-name").textContent = product.name;
        node.querySelector(".price").textContent =
          `$${product.price.toFixed(3)}`;

        // Abrir vista de producto
        node.addEventListener("click", (e) => {
          if (e.target.closest(".addCart")) return;

          const imagesContainer = $viewProduct.querySelector(".images");
          imagesContainer.innerHTML = "";
          product.images.forEach((imgPath) => {
            const im = document.createElement("img");
            im.src = `.${cleanImagePath(imgPath)}`;
            im.alt = product.name;
            imagesContainer.appendChild(im);
          });

          $viewProduct.querySelector(".name").textContent = product.name;
          $viewProduct.querySelector(".details").innerHTML =
            product.details.replace(/\n/g, "<br>");
          $viewProduct.style.display = "flex";
          currentProductIndex = idx;
        });

        fragment.appendChild(node);
      });

      listProductHTML.appendChild(fragment);
    } else {
      // ⚠️ Mostrar mensaje cuando no hay resultados
      const message = document.createElement("div");
      message.classList.add("no-results");
      message.textContent = "No se encontraron productos..";
      listProductHTML.appendChild(message);
    }
  };

  // Buscador
  $searchInput?.addEventListener("input", (e) => {
    searchTerm = e.target.value;
    addDataToHTML();
  });

  // Click en "Agregar" desde la card
  listProductHTML.addEventListener("click", (event) => {
    if (event.target.classList.contains("addCart")) {
      const product_id = event.target.closest(".item").dataset.id;
      addToCart(product_id);
      animateCartIcon();
    }
  });

  // Click en "Agregar" dentro de la vista de producto
  document
    .querySelector("#v-product .addCart")
    ?.addEventListener("click", () => {
      if (currentProductIndex !== null) {
        addToCart(currentProductIndex);
        animateCartIcon();
      }
    });

  // Carrito: lógica
  const addToCart = (product_id) => {
    const index = cart.findIndex((item) => item.product_id == product_id);
    if (index === -1) {
      cart.push({ product_id, quantity: 1 });
    } else {
      cart[index].quantity++;
    }
    addCartToHTML();
    addCartToMemory();
  };

  const addCartToMemory = () => {
    localStorage.setItem("cart", JSON.stringify(cart));
  };

  const addCartToHTML = () => {
    listCartHTML.innerHTML = "";
    let totalQuantity = 0;
    let totalPrice = 0;
    const fragment = document.createDocumentFragment();

    cart.forEach((item) => {
      const product = products[item.product_id];
      if (!product) return;

      const itemTotal = product.price * item.quantity;
      totalQuantity += item.quantity;
      totalPrice += itemTotal;

      const newItem = document.createElement("div");
      newItem.classList.add("item", "flex-row");
      newItem.dataset.id = item.product_id;
      newItem.innerHTML = `
        <div class="image flex-row">
          <img src=".${cleanImagePath(product.images[0])}" alt="${product.name}">
        </div>
        <div class="name">${product.name}</div>
        <div class="totalPrice">$${itemTotal.toFixed(3)}</div>
        <div class="quantity flex-row">
          <span><i class="bi bi-dash minus"></i></span>
          <span>${item.quantity}</span>
          <span><i class="bi bi-plus plus"></i></span>
        </div>`;
      fragment.appendChild(newItem);
    });

    listCartHTML.appendChild(fragment);

    const totalSection = document.createElement("div");
    totalSection.classList.add("cart-total");
    totalSection.innerHTML = `<strong>Total: $${totalPrice.toFixed(3)}</strong>`;
    listCartHTML.appendChild(totalSection);
    iconCartSpan.innerText = totalQuantity;
  };

  // Cambiar cantidad en carrito
  listCartHTML.addEventListener("click", (event) => {
    const isMinus = event.target.classList.contains("minus");
    const isPlus = event.target.classList.contains("plus");
    if (!isMinus && !isPlus) return;
    const product_id = event.target.closest(".item").dataset.id;
    changeQuantityCart(product_id, isMinus ? "minus" : "plus");
  });

  const changeQuantityCart = (product_id, type) => {
    const index = cart.findIndex((item) => item.product_id == product_id);
    if (index === -1) return;
    if (type === "plus") cart[index].quantity++;
    if (type === "minus") {
      cart[index].quantity--;
      if (cart[index].quantity === 0) cart.splice(index, 1);
    }
    addCartToHTML();
    addCartToMemory();
  };

  // Animación del icono carrito
  const animateCartIcon = () => {
    iconCart.classList.add("animate-cart");
    setTimeout(() => iconCart.classList.remove("animate-cart"), 300);
  };

  // Init
  const initApp = () => {
    fetch("./JSON/products.json")
      .then((response) => response.json())
      .then((data) => {
        allProductsByCategory = data;
        products = Object.values(data).flat();
        renderCategoryButtons();
        addDataToHTML();

        const storedCart = localStorage.getItem("cart");
        if (storedCart) {
          cart = JSON.parse(storedCart);
          addCartToHTML();
        }
      })
      .catch((error) => console.error("Error cargando productos:", error));
  };

  window.addEventListener("DOMContentLoaded", initApp);
</script>
